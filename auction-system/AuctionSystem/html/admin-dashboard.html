<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍卖系统 - 管理员后台</title>
    <!-- 引入Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">管理员后台</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#">管理员面板</a>
                <a class="nav-link" href="#" onclick="logout()">退出登录</a>
                <script>
                    function logout() {
                        localStorage.removeItem('token');
                        alert('已退出登录');
                        window.location.href = 'login.html';
                    }
                </script>
            </div>
        </div>
    </nav>

    <!-- 后台布局 -->
    <div class="container-fluid" style="margin-top: 56px;">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 p-0">
                <div class="admin-sidebar">
                    <h4 class="mb-4">管理菜单</h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#itemManage">拍品管理</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10">
                <div class="admin-content" id="itemManage">
                    <h3 class="mb-4">拍品管理</h3>
                    
                    <!-- 添加/修改拍品按钮 -->
                    <div class="mb-4">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">添加拍品</button>
                        <button class="btn btn-outline-secondary ms-2" id="batchDeleteBtn">批量删除</button>
                    </div>

                    <!-- 拍品列表 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox"></th>
                                            <th>ID</th>
                                            <th>拍品名称</th>
                                            <th>起拍价</th>
                                            <th>当前最高价</th>
                                            <th>竞拍状态</th>
                                            <th>开始时间</th>
                                            <th>结束时间</th>
                                            <th>上架状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9" class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-2">正在加载拍品数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加拍品模态框 -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">添加拍品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">拍品名称</label>
                                <input type="text" id="addItemTitle" name="title" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">起拍价（元）</label>
                                <input type="number" id="addItemInitialPrice" name="initialPrice" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><span style="color: red;">*</span> 拍品图片：</label>
                            <!-- 隐藏的图片URL存储 -->
                            <input type="hidden" id="addItemImageUrl" value="">
                            
                            <div style="display: flex; gap: 30px; align-items: flex-start;">
                                <!-- 上传区域 -->
                                <div id="addUploadContainer" style="border: 2px dashed #ddd; border-radius: 4px; padding: 60px 40px; text-align: center; cursor: pointer; transition: all 0.3s; flex-shrink: 0; width: 300px;" 
                                     onmouseover="this.style.borderColor='#999'; this.style.backgroundColor='#f9f9f9';"
                                     onmouseout="this.style.borderColor='#ddd'; this.style.backgroundColor='white';">
                                    <div style="font-size: 32px; color: #999; margin-bottom: 10px;">↑</div>
                                    <div style="font-size: 14px; color: #666; font-weight: 500;">上传图片</div>
                                    <input type="file" accept="image/*" style="display: none;" id="addItemImageInput">
                                </div>
                                
                                <!-- 说明文字 -->
                                <div style="flex: 1; padding-top: 20px;">
                                    <div style="font-size: 12px; color: #999; line-height: 1.8;">
                                        <div style="margin-bottom: 8px;">图片大小不超过2M</div>
                                        <div style="margin-bottom: 8px;">仅能上传 PNG JPEG JPG 类型图片</div>
                                        <div>建议上传200*200或300*300尺寸的图片</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 图片预览区域 -->
                            <div id="addItemPreviewContainer" style="margin-top: 20px; display: none;">
                                <div style="display: flex; gap: 30px; align-items: flex-start;">
                                    <div style="flex-shrink: 0;">
                                        <img id="addItemPreviewImg" style="max-width: 300px; max-height: 250px; border-radius: 4px; border: 1px solid #eee;" />
                                    </div>
                                    <div style="flex: 1; padding-top: 20px;">
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="addItemDeleteBtn">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <script>
                            // 添加拍品图片上传逻辑将在主脚本中由setupAddImageUpload处理
                        </script>
                        <div class="mb-3">
                            <label class="form-label">拍品描述</label>
                            <textarea id="addItemDesc" name="description" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">起拍时间</label>
                                <input type="datetime-local" id="addItemStartTime" name="startTime" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">结束时间</label>
                                <input type="datetime-local" id="addItemEndTime" name="endTime" class="form-control" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="addItemSubmitBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑拍品模态框 -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">编辑拍品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editItemForm">
                        <input type="hidden" id="editItemId" name="id" value="1">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">拍品名称</label>
                                <input type="text" id="editItemTitle" name="title" class="form-control" value="古董瓷器花瓶" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">起拍价（元）</label>
                                <input type="number" id="editItemInitialPrice" name="initialPrice" class="form-control" step="0.01" min="0" value="2000.00" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><span style="color: red;">*</span> 拍品图片：</label>
                            <!-- 隐藏的图片URL存储 -->
                            <input type="hidden" id="editItemImageUrl" value="">
                            
                            <!-- 已上传图片显示 -->
                            <div id="editItemPreviewContainer" style="display: flex; gap: 30px; align-items: flex-start;">
                                <div style="flex-shrink: 0;">
                                    <img id="editItemImg" src="" style="max-width: 300px; max-height: 250px; border-radius: 4px; border: 1px solid #eee;" />
                                </div>
                                <div style="flex: 1; padding-top: 20px;">
                                    <div style="font-size: 12px; color: #999; line-height: 1.8; margin-bottom: 15px;">
                                        <div style="margin-bottom: 8px;">图片大小不超过2M</div>
                                        <div style="margin-bottom: 8px;">仅能上传 PNG JPEG JPG 类型图片</div>
                                        <div>建议上传200*200或300*300尺寸的图片</div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="editChangeImageBtn">更换图片</button>
                                </div>
                            </div>
                            
                            <!-- 上传区域 -->
                            <div id="editUploadContainer" style="display: none; gap: 30px; align-items: flex-start;">
                                <div id="editUploadArea" style="border: 2px dashed #ddd; border-radius: 4px; padding: 60px 40px; text-align: center; cursor: pointer; transition: all 0.3s; flex-shrink: 0; width: 300px;" 
                                     onmouseover="this.style.borderColor='#999'; this.style.backgroundColor='#f9f9f9';"
                                     onmouseout="this.style.borderColor='#ddd'; this.style.backgroundColor='white';">
                                    <div style="font-size: 32px; color: #999; margin-bottom: 10px;">↑</div>
                                    <div style="font-size: 14px; color: #666; font-weight: 500;">上传图片</div>
                                    <input type="file" accept="image/*" style="display: none;" id="editItemImageInput">
                                </div>
                                
                                <!-- 说明文字 -->
                                <div style="flex: 1; padding-top: 20px;">
                                    <div style="font-size: 12px; color: #999; line-height: 1.8;">
                                        <div style="margin-bottom: 8px;">图片大小不超过2M</div>
                                        <div style="margin-bottom: 8px;">仅能上传 PNG JPEG JPG 类型图片</div>
                                        <div>建议上传200*200或300*300尺寸的图片</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 编辑拍品图片上传逻辑将在模态框加载后由主脚本中的postFormData处理 -->
                        <div class="mb-3">
                            <label class="form-label">拍品描述</label>
                            <textarea id="editItemDesc" name="description" class="form-control" rows="3" required>此花瓶为清代中期官窑出品，器型规整，釉色温润，保存完好，具有较高的收藏价值。</textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">起拍时间</label>
                                <input type="datetime-local" id="editItemStartTime" name="startTime" class="form-control" value="2025-12-01T10:00" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">结束时间</label>
                                <input type="datetime-local" id="editItemEndTime" name="endTime" class="form-control" value="2025-12-31T23:59" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="editItemSubmitBtn">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { get, post, put, del, postFormData, formatDateTime, formatCurrency } from './utils/request.js';
        
        // 检查管理员登录状态
        function checkAdminLogin() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录管理员账户');
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查管理员登录状态
            if (!checkAdminLogin()) {
                return;
            }
            
            loadItemList();
                    
            // 为添加拍品的图片上传设置事件监听
            setupAddImageUpload();
                    
            // 添加拍品按锕点击事件
            document.getElementById('addItemSubmitBtn').addEventListener('click', function() {
                // 手动触发表单提交
                document.getElementById('addItemForm').dispatchEvent(new Event('submit'));
            });
                        
            // 编辑拍品按钮点击事件
            document.getElementById('editItemSubmitBtn').addEventListener('click', function() {
                // 手动触发表单提交
                document.getElementById('editItemForm').dispatchEvent(new Event('submit'));
            });
            
            // 批量删除按钮点击事件
            document.getElementById('batchDeleteBtn').addEventListener('click', function() {
                batchDeleteItems();
            });
            
            // 表头全选复选框事件
            document.querySelector('thead input[type="checkbox"]').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('tbody input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
            
            // 编辑拍品表单提交事件
            document.getElementById('editItemForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 从隐藏输入框读取图片URL
                const imageUrl = document.getElementById('editItemImageUrl').value;
                
                const itemData = {
                    id: parseInt(document.getElementById('editItemId').value),
                    title: document.getElementById('editItemTitle').value,
                    initialPrice: parseFloat(document.getElementById('editItemInitialPrice').value),
                    description: document.getElementById('editItemDesc').value,
                    startTime: document.getElementById('editItemStartTime').value,
                    endTime: document.getElementById('editItemEndTime').value,
                    image: imageUrl // 从隐藏输入框中读取，即使不改也会有值
                };
                
                console.log('编辑拍品数据:', itemData);
                
                try {
                    const response = await put('/item/update', itemData);
                    
                    if (response.code === 1) {
                        alert('修改成功！');
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
                        editModal.hide();
                        // 重新加载拍品列表
                        loadItemList();
                        // 清空图片URL
                        document.getElementById('editItemImageUrl').value = '';
                    } else {
                        alert('修改失败: ' + response.msg);
                    }
                } catch (error) {
                    console.error('修改异常:', error);
                    alert('修改异常，请稍后重试');
                }
            });
        });
        
        // 加载拍品列表
        async function loadItemList() {
            try {
                const response = await get('/item/list/admin', {
                    page: 1,
                    pageSize: 100 // 获取所有拍品
                });
                
                if (response.code === 1) {
                    renderItemList(response.data.records);
                } else {
                    console.error('获取拍品列表失败:', response.msg);
                    showErrorMessage('获取拍品列表失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取拍品列表异常:', error);
                showErrorMessage('获取拍品列表异常');
            }
        }
        
        // 渲染拍品列表
        function renderItemList(items) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!items || items.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="9" class="text-center text-muted">暂无拍品数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            items.forEach(item => {
                const tr = document.createElement('tr');
                
                // 根据状态设置标签
                let statusText = '';
                let statusClass = '';
                
                switch (item.status) {
                    case 0: // 未开始
                        statusText = '未开始';
                        statusClass = 'bg-secondary';
                        break;
                    case 1: // 竞拍中
                        statusText = '竞拍中';
                        statusClass = 'bg-primary';
                        break;
                    case 2: // 已结束
                        statusText = '已结束';
                        statusClass = 'bg-success';
                        break;
                    default:
                        statusText = '未知';
                        statusClass = 'bg-secondary';
                }
                
                tr.innerHTML = `
                    <td><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.id}</td>
                    <td>${item.title}</td>
                    <td>${formatCurrency(item.initialPrice)}</td>
                    <td>${formatCurrency(item.currentMaxPrice || 0)}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${formatDateTime(item.startTime)}</td>
                    <td>${formatDateTime(item.endTime)}</td>
                    <td><span class="badge ${item.listingStatus === 1 ? 'bg-primary' : 'bg-secondary'}">${item.listingStatus === 1 ? '上架中' : '下架中'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${item.id}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${item.id}">删除</button>
                        <button class="btn btn-sm btn-outline-success listing-status-btn" data-id="${item.id}" data-status="${item.listingStatus || 0}">${(item.listingStatus || 0) === 1 ? '下架' : '上架'}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // 绑定编辑按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    editItem(itemId);
                });
            });
            
            // 绑定删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    deleteItem(itemId);
                });
            });
            
            // 绑定上架/下架按钮事件
            document.querySelectorAll('.listing-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    const currentStatus = parseInt(this.dataset.status);
                    toggleListingStatus(itemId, currentStatus, this);
                });
            });
        }
        
        // 编辑拍品
        async function editItem(itemId) {
            try {
                const response = await get(`/item/${itemId}`);
                
                if (response.code === 1) {
                    const item = response.data;
                    // 填充编辑表单
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editItemTitle').value = item.title;
                    document.getElementById('editItemInitialPrice').value = item.initialPrice;
                    document.getElementById('editItemDesc').value = item.description;
                    document.getElementById('editItemStartTime').value = item.startTime.slice(0, 16); // 格式化为datetime-local
                    document.getElementById('editItemEndTime').value = item.endTime.slice(0, 16); // 格式化为datetime-local
                    
                    // 处理图片显示
                    const editItemImg = document.getElementById('editItemImg');
                    const editItemPreviewContainer = document.getElementById('editItemPreviewContainer');
                    const editUploadContainer = document.getElementById('editUploadContainer');
                    const imageUrlInput = document.getElementById('editItemImageUrl');
                    
                    if (item.image) {
                        // 保存原始图片URL到隐藏输入框
                        imageUrlInput.value = item.image;
                        editItemImg.src = item.image;
                        editItemPreviewContainer.style.display = 'flex';
                        editUploadContainer.style.display = 'none';
                    } else {
                        // 如果没有图片，显示上传区域
                        editItemPreviewContainer.style.display = 'none';
                        editUploadContainer.style.display = 'flex';
                        imageUrlInput.value = ''; // 清空图片URL
                    }
                    
                    // 显示编辑模态框
                    const editModal = new bootstrap.Modal(document.getElementById('editItemModal'));
                    editModal.show();
                    
                    // 在模态框打开后，为编辑图片上传添加事件监听
                    setupEditImageUpload();
                } else {
                    alert('获取拍品详情失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取拍品详情异常:', error);
                alert('获取拍品详情异常');
            }
        }
        
        // 设置编辑图片上传事件
        function setupEditImageUpload() {
            const imageUrlInput = document.getElementById('editItemImageUrl');
            const previewContainer = document.getElementById('editItemPreviewContainer');
            const previewImg = document.getElementById('editItemImg');
            const uploadContainer = document.getElementById('editUploadContainer');
            const uploadArea = document.getElementById('editUploadArea');
            const imageInput = document.getElementById('editItemImageInput');
            const changeImageBtn = document.getElementById('editChangeImageBtn');
            
            // 移除旧的事件监听器（如果有的话）
            changeImageBtn.removeEventListener('click', changeImageClickHandler);
            uploadArea.removeEventListener('click', uploadAreaClickHandler);
            imageInput.removeEventListener('change', imageInputChangeHandler);
            uploadArea.removeEventListener('dragover', uploadAreaDragOverHandler);
            uploadArea.removeEventListener('dragleave', uploadAreaDragLeaveHandler);
            uploadArea.removeEventListener('drop', uploadAreaDropHandler);
            
            // 更换图片按锕
            changeImageBtn.addEventListener('click', changeImageClickHandler);
            
            // 点击上传区域打开文件选择
            uploadArea.addEventListener('click', uploadAreaClickHandler);
            
            // 文件选择变化事件
            imageInput.addEventListener('change', imageInputChangeHandler);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', uploadAreaDragOverHandler);
            uploadArea.addEventListener('dragleave', uploadAreaDragLeaveHandler);
            uploadArea.addEventListener('drop', uploadAreaDropHandler);
            
            // 上传图片函数
            async function uploadImage(file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // 使用postFormData函数，确保携带token
                    const result = await postFormData('/admin/common/upload', formData);
                    
                    if (result.code === 1) {
                        // 上传成功，保存URL到隐藏输入框
                        imageUrlInput.value = result.data;
                        
                        // 显示预览
                        previewImg.src = result.data;
                        uploadContainer.style.display = 'none';
                        previewContainer.style.display = 'flex';
                        
                        console.log('编辑图片上传成功:', result.data);
                    } else {
                        alert('图片上传失败: ' + result.msg);
                        imageInput.value = '';
                    }
                } catch (error) {
                    console.error('图片上传异常:', error);
                    alert('图片上传异常，请稍后重试');
                    imageInput.value = '';
                }
            }
            
            // 事件处理器函数
            function changeImageClickHandler(e) {
                e.preventDefault();
                previewContainer.style.display = 'none';
                uploadContainer.style.display = 'flex';
            }
            
            function uploadAreaClickHandler() {
                imageInput.click();
            }
            
            function imageInputChangeHandler() {
                if (imageInput.files && imageInput.files[0]) {
                    uploadImage(imageInput.files[0]);
                }
            }
            
            function uploadAreaDragOverHandler(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#999';
                uploadArea.style.backgroundColor = '#f9f9f9';
            }
            
            function uploadAreaDragLeaveHandler(e) {
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = 'white';
            }
            
            function uploadAreaDropHandler(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = 'white';
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    uploadImage(e.dataTransfer.files[0]);
                }
            }
        }
        
        // 设置添加图片上传事件
        function setupAddImageUpload() {
            const uploadContainer = document.getElementById('addUploadContainer');
            const imageInput = document.getElementById('addItemImageInput');
            const imageUrlInput = document.getElementById('addItemImageUrl');
            const previewContainer = document.getElementById('addItemPreviewContainer');
            const previewImg = document.getElementById('addItemPreviewImg');
            const deleteBtn = document.getElementById('addItemDeleteBtn');
            const uploadArea = document.getElementById('addUploadContainer');
            
            // 点击上传区域打开文件选择
            uploadContainer.addEventListener('click', function() {
                imageInput.click();
            });
            
            // 文件选择变化事件
            imageInput.addEventListener('change', async function() {
                if (this.files && this.files[0]) {
                    await uploadImage(this.files[0]);
                }
            });
            
            // 拖拽上传
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#999';
                this.style.backgroundColor = '#f9f9f9';
            });
            
            uploadContainer.addEventListener('dragleave', function(e) {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'white';
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'white';
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    uploadImage(e.dataTransfer.files[0]);
                }
            });
            
            // 删除图片
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                imageUrlInput.value = '';
                imageInput.value = '';
                previewContainer.style.display = 'none';
                uploadArea.style.display = 'block';
            });
            
            // 上传图片函数
            async function uploadImage(file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // 使用postFormData函数，确保携带token
                    const result = await postFormData('/admin/common/upload', formData);
                    
                    if (result.code === 1) {
                        // 上传成功，保存URL到隐藏的输入框
                        imageUrlInput.value = result.data;
                        
                        // 显示预览
                        previewImg.src = result.data;
                        previewContainer.style.display = 'block';
                        uploadArea.style.display = 'none';
                        
                        console.log('图片上传成功:', result.data);
                    } else {
                        alert('图片上传失败: ' + result.msg);
                        imageInput.value = '';
                    }
                } catch (error) {
                    console.error('图片上传异常:', error);
                    alert('图片上传异常，请稍后重试');
                    imageInput.value = '';
                }
            }
        }
        
        // 删除拍品
        async function deleteItem(itemId) {
            if (!confirm('确定要删除该拍品吗？')) {
                return;
            }
            
            try {
                const response = await del('/item', { ids: [itemId] });
                
                if (response.code === 1) {
                    alert('删除成功！');
                    // 重新加载拍品列表
                    loadItemList();
                } else {
                    alert('删除失败: ' + response.msg);
                }
            } catch (error) {
                console.error('删除异常:', error);
                alert('删除异常，请稍后重试');
            }
        }
        
        // 上架/下架拍品
        async function toggleListingStatus(itemId, currentStatus, buttonElement) {
            // 确认操作
            const actionText = currentStatus === 1 ? '下架' : '上架';
            if (!confirm(`确定要${actionText}该拍品吗？`)) {
                return;
            }
            
            try {
                const newStatus = currentStatus === 1 ? 0 : 1;
                // 根据说明文件，接口路径应为 /item/{listingStatus}，itemId作为查询参数
                const response = await put(`/item/${newStatus}?itemId=${itemId}`, {});
                
                if (response.code === 1) {
                    alert(`${actionText}成功！`);
                    // 更新按钮状态和文本
                    buttonElement.dataset.status = newStatus;
                    buttonElement.textContent = newStatus === 1 ? '下架' : '上架';
                    // 重新加载拍品列表
                    loadItemList();
                } else {
                    alert(`${actionText}失败: ` + response.msg);
                }
            } catch (error) {
                console.error(`${actionText}异常:`, error);
                alert(`${actionText}异常，请稍后重试`);
            }
        }
        
        // 批量删除拍品
        async function batchDeleteItems() {
            // 获取所有选中的复选框
            const selectedCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('请至少选择一个拍品进行删除');
                return;
            }
            
            // 获取选中的拍品ID
            const itemIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
            
            if (!confirm(`确定要删除选中的 ${itemIds.length} 个拍品吗？`)) {
                return;
            }
            
            try {
                const response = await del('/item', { ids: itemIds });
                
                if (response.code === 1) {
                    alert('批量删除成功！');
                    // 重新加载拍品列表
                    loadItemList();
                    // 取消全选
                    document.querySelector('thead input[type="checkbox"]').checked = false;
                } else {
                    alert('批量删除失败: ' + response.msg);
                }
            } catch (error) {
                console.error('批量删除异常:', error);
                alert('批量删除异常，请稍后重试');
            }
        }
        
        // 添加拍品表单提交事件
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 从隐藏输入框读取图片URL
            const imageUrl = document.getElementById('addItemImageUrl').value;
            
            // 验证图片是否已上传
            if (!imageUrl || imageUrl.trim() === '') {
                alert('请先上传拍品图片');
                return;
            }
            
            const itemData = {
                title: document.getElementById('addItemTitle').value,
                initialPrice: parseFloat(document.getElementById('addItemInitialPrice').value),
                description: document.getElementById('addItemDesc').value,
                startTime: document.getElementById('addItemStartTime').value,
                endTime: document.getElementById('addItemEndTime').value,
                image: imageUrl // 从隐藏输入框中读取
            };
            
            console.log('添加拍品数据:', itemData);
            
            try {
                const response = await put('/item/add', itemData);
                
                if (response.code === 1) {
                    alert('添加成功！');
                    const addModal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                    addModal.hide();
                    // 重新加载拍品列表
                    loadItemList();
                    // 清空表单
                    document.getElementById('addItemForm').reset();
                    document.getElementById('addItemImageUrl').value = '';
                    document.getElementById('addItemImageInput').value = '';
                    document.getElementById('addItemPreviewContainer').style.display = 'none';
                    document.getElementById('addUploadContainer').style.display = 'block';
                } else {
                    alert('添加失败: ' + response.msg);
                }
            } catch (error) {
                console.error('添加异常:', error);
                alert('添加异常，请稍后重试');
            }
        });
        
        // 显示错误信息
        function showErrorMessage(message) {
            const container = document.querySelector('.admin-content');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }
    </script>
</body>
</html>