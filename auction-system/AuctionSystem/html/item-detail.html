<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍卖系统 - 拍品详情</title>
    <!-- 引入Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="common.css"></head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="index.html">拍卖系统</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">返回拍品列表</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userNavbar">
                    <!-- 动态加载用户相关的导航项 -->
                </ul>
                <script>
                    // 检查用户登录状态并更新导航栏
                    function checkLoginStatus() {
                        const token = localStorage.getItem('token');
                        const userNavbar = document.getElementById('userNavbar');
                        
                        if (token) {
                            // 用户已登录
                            userNavbar.innerHTML = `
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                        我的账户
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="user-order.html">我的订单</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
                                    </ul>
                                </li>
                            `;
                        } else {
                            // 用户未登录
                            userNavbar.innerHTML = `
                                <li class="nav-item">
                                    <a class="nav-link" href="login.html">登录</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="register.html">注册</a>
                                </li>
                            `;
                        }
                    }
                    
                    // 退出登录函数
                    function logout() {
                        localStorage.removeItem('token');
                        alert('已退出登录');
                        window.location.href = 'login.html';
                    }
                    
                    // 页面加载时检查登录状态
                    document.addEventListener('DOMContentLoaded', function() {
                        checkLoginStatus();
                    });
                </script>
            </div>
        </div>
    </nav>

    <!-- 拍品详情 -->
    <div class="container mt-4">
        <div class="row">
            <!-- 拍品图片 -->
            <div class="col-md-6">
                <img src="" class="img-fluid rounded" alt="拍品图片" id="itemImage">
            </div>

            <!-- 拍品信息和出价区 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0" id="itemTitle"></h4>
                        <span class="badge" id="itemStatus"></span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p class="text-muted mb-1" id="itemDescription">
                            </p>
                        </div>
                        <div class="mb-2">
                            <h5 id="itemPrice"></h5>
                        </div>
                        <div class="mb-2">
                            <p class="text-muted" id="itemInitialPrice"></p>
                        </div>
                        <div class="mb-3">
                            <p id="itemTime"></p>
                        </div>
                        <hr>
                        <h5 class="mb-3">出价竞拍</h5>
                        <div class="mb-3">
                            <input type="number" class="form-control" id="bidPrice" placeholder="" min="0">
                        </div>
                        <button class="btn btn-danger bid-btn" id="bidButton" disabled>立即出价</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 竞拍记录 -->
        <div class="mt-5">
            <h4>竞拍记录</h4>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>出价时间</th>
                                    <th>出价用户</th>
                                    <th>出价金额</th>
                                </tr>
                            </thead>
                            <tbody id="bidRecordsBody">
                                <tr>
                                    <td colspan="3" class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        <p class="mt-2">正在加载竞拍记录...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { get, post, formatDateTime, formatCurrency } from './utils/request.js';

        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (itemId) {
                loadItemDetail(itemId);
                loadBidRecords(itemId);
            } else {
                showErrorMessage('缺少拍品ID参数');
            }
        });

        // 加载拍品详情
        async function loadItemDetail(id) {
            try {
                const response = await get(`/item/${id}`);
                
                if (response.code === 1) {
                    renderItemDetail(response.data);
                } else {
                    console.error('获取拍品详情失败:', response.msg);
                    showErrorMessage('获取拍品详情失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取拍品详情异常:', error);
                showErrorMessage('获取拍品详情异常');
            }
        }

        // 渲染拍品详情
        function renderItemDetail(item) {
            // 更新标题
            document.querySelector('h4').textContent = item.title;
            
            // 更新状态标签
            const statusBadge = document.querySelector('.badge');
            switch (item.status) {
                case 0: // 未开始
                    statusBadge.textContent = '未开始';
                    statusBadge.className = 'badge bg-secondary';
                    break;
                case 1: // 竞拍中
                    statusBadge.textContent = '竞拍中';
                    statusBadge.className = 'badge bg-primary';
                    break;
                case 2: // 已结束
                    statusBadge.textContent = '已结束';
                    statusBadge.className = 'badge bg-success';
                    break;
                default:
                    statusBadge.textContent = '未知';
                    statusBadge.className = 'badge bg-secondary';
            }
            
            // 更新价格信息
            if (item.status === 2) {
                document.querySelector('h5').innerHTML = `最终成交价：<span class="text-danger">${formatCurrency(item.currentMaxPrice)}</span>`;
            } else {
                document.querySelector('h5').innerHTML = `当前最高价：<span class="text-danger">${formatCurrency(item.currentMaxPrice)}</span>`;
                document.querySelectorAll('p.text-muted')[0].innerHTML = `起拍价：${formatCurrency(item.initialPrice)}`;
            }
            
            // 更新时间信息
            const timeText = `<strong>竞拍时间：</strong>${formatDateTime(item.startTime)} 至 ${formatDateTime(item.endTime)}`;
            document.querySelectorAll('p')[2].innerHTML = timeText;
            
            // 更新图片
            const imgElement = document.querySelector('.img-fluid');
            if (item.image) {
                imgElement.src = item.image;
                imgElement.style.display = 'block';
            } else {
                // 如果没有图片，隐藏图片元素或显示默认占位图
                imgElement.style.display = 'none';
                // 或者显示默认占位图:
                // imgElement.src = 'path/to/default-image.png';
                // imgElement.alt = '暂无图片';
            }
            
            // 更新描述
            document.querySelector('.text-muted:last-child').textContent = item.description;
            
            // 更新出价输入框
            const bidInput = document.querySelector('input[type="number"]');
            if (item.status === 1) { // 竞拍中
                // 计算最小出价金额（当前最高价+10）
                const minBidPrice = item.currentMaxPrice + 10;
                bidInput.min = minBidPrice;
                bidInput.placeholder = `请输入出价金额（最低${formatCurrency(minBidPrice)}）`;
                bidInput.disabled = false;
                document.querySelector('.bid-btn').disabled = false;
            } else {
                bidInput.disabled = true;
                document.querySelector('.bid-btn').disabled = true;
                if (item.status === 0) {
                    bidInput.placeholder = '竞拍尚未开始';
                } else {
                    bidInput.placeholder = '竞拍已结束';
                }
            }
        }

        // 加载竞拍记录
        async function loadBidRecords(id) {
            try {
                const response = await get(`/bid/records/${id}`);
                
                if (response.code === 1) {
                    // 从返回数据中提取记录
                    const records = response.data.data || [];
                    renderBidRecords(records);
                } else {
                    console.error('获取竞拍记录失败:', response.msg);
                    showRecordsErrorMessage('获取竞拍记录失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取竞拍记录异常:', error);
                showRecordsErrorMessage('获取竞拍记录异常');
            }
        }

        // 渲染竞拍记录
        function renderBidRecords(records) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!records || records.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="3" class="text-center text-muted">暂无竞拍记录</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // 数据库返回的数据结构：bidTime(毫秒时间戳), userId, bidPrice
            records.forEach(record => {
                const tr = document.createElement('tr');
                
                // 时间戳已经是毫秒级的，直接使用
                const timestamp = typeof record.bidTime === 'number' ? record.bidTime : 0;
                const bidDate = new Date(timestamp);
                const formattedTime = formatDateTime(bidDate);                
                // userId 或 bidderId
                const userId = record.userId || record.bidderId || '匿名用户';
                
                // bidPrice 需要格式化为货币
                const bidPrice = formatCurrency(record.bidPrice);
                
                tr.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${userId}</td>
                    <td>${bidPrice}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 出价功能
        document.querySelector('.bid-btn').addEventListener('click', async function() {
            // 检查用户是否已登录
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录后再出价！');
                // 跳转到登录页面
                window.location.href = 'login.html';
                return;
            }
            
            const bidPrice = document.querySelector('input[type="number"]').value;
            
            if (!bidPrice) {
                alert('请输入出价金额！');
                return;
            }
            
            // 检查出价金额是否符合要求
            const currentMaxPrice = parseFloat(document.querySelector('input[type="number"]').min);
            if (parseFloat(bidPrice) < currentMaxPrice) {
                alert(`出价金额不能低于最低出价${formatCurrency(currentMaxPrice)}！`);
                return;
            }
            
            try {
                const response = await post('/bid', {
                    itemId: parseInt(itemId),
                    bidPrice: parseFloat(bidPrice)
                });
                
                if (response.code === 1) {
                    alert('出价成功！');
                    // 重新加载拍品详情和竞拍记录
                    loadItemDetail(itemId);
                    loadBidRecords(itemId);
                } else {
                    alert('出价失败: ' + response.msg);
                }
            } catch (error) {
                console.error('出价异常:', error);
                alert('出价异常，请稍后重试');
            }
        });

        // 显示错误信息
        function showErrorMessage(message) {
            document.querySelector('.card-body').innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        // 显示记录错误信息
        function showRecordsErrorMessage(message) {
            document.querySelector('tbody').innerHTML = `<tr><td colspan="3" class="text-center text-danger">${message}</td></tr>`;
        }
    </script>
</body>
</html>