<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍卖系统 - 首页</title>
    <!-- 引入Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="index.html">拍卖系统</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">拍品列表</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userNavbar">
                    <!-- 动态加载用户相关的导航项 -->
                </ul>
                <script>
                    // 检查用户登录状态并更新导航栏
                    function checkLoginStatus() {
                        const token = localStorage.getItem('token');
                        const userNavbar = document.getElementById('userNavbar');
                        
                        if (token) {
                            // 用户已登录
                            userNavbar.innerHTML = `
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                        我的账户
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="user-order.html">我的订单</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
                                    </ul>
                                </li>
                            `;
                        } else {
                            // 用户未登录
                            userNavbar.innerHTML = `
                                <li class="nav-item">
                                    <a class="nav-link" href="login.html">登录</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="register.html">注册</a>
                                </li>
                            `;
                        }
                    }
                    
                    // 退出登录函数
                    function logout() {
                        localStorage.removeItem('token');
                        alert('已退出登录');
                        window.location.href = 'login.html';
                    }
                    
                    // 页面加载时检查登录状态
                    document.addEventListener('DOMContentLoaded', function() {
                        checkLoginStatus();
                    });
                </script>
            </div>
        </div>
    </nav>

    <!-- 搜索筛选栏 -->
    <div class="container mt-4">
        <div class="card p-4 mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="关键词搜索">
                </div>
                <div class="col-md-2">
                    <select class="form-select">
                        <option value="">全部状态</option>
                        <option value="0">未开始</option>
                        <option value="1">竞拍中</option>
                        <option value="2">已结束</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" placeholder="最低价格">
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" placeholder="最高价格">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary me-2">搜索</button>
                    <button class="btn btn-outline-secondary">重置</button>
                </div>
            </div>
        </div>

        <!-- 拍品列表 -->
        <div class="row g-4" id="itemListContainer">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载拍品数据...</p>
            </div>
        </div>

        <!-- 分页 -->
        <div class="mt-5 mb-4">
            <div class="d-flex align-items-center justify-content-center gap-3 flex-wrap">
                <!-- 总条数 -->
                <div class="text-nowrap">
                    <span class="text-muted">共<span id="totalItems">0</span>条</span>
                </div>

                <!-- 每页条数 -->
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" style="width: 100px;">
                        <option value="9" selected>9条/页</option>
                        <option value="12">12条/页</option>
                        <option value="15">15条/页</option>
                        <option value="18">18条/页</option>
                        <option value="21">21条/页</option>
                    </select>
                </div>

                <!-- 分页导航 -->
                <div class="d-flex align-items-center gap-2">
                    <!-- 上一页 -->
                    <button class="btn btn-outline-secondary btn-sm prev-btn" onclick="previousPage()" style="width: 32px; height: 32px; padding: 0;">
                        ‹
                    </button>

                    <!-- 页码 -->
                    <div class="d-flex gap-1" id="paginationButtons">
                        <!-- 动态生成页码按钮 -->
                    </div>

                    <!-- 下一页 -->
                    <button class="btn btn-outline-secondary btn-sm next-btn" onclick="nextPage()" style="width: 32px; height: 32px; padding: 0;">
                        ›
                    </button>
                </div>

                <!-- 前往页码 -->
                <div class="d-flex align-items-center gap-2 text-nowrap">
                    <span class="text-muted">前往</span>
                    <input type="number" class="form-control form-control-sm goto-input" placeholder="1" style="width: 50px; height: 32px;" min="1" max="3">
                    <span class="text-muted">页</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { get, formatDateTime } from './utils/request.js';
        
        let currentPage = 1;
        let totalPages = 1;
        let totalItems = 0;
        let pageSize = 9; // 每页显示条数，初始值为9
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定每页条数选择控件的事件
            // 绑定每页条数选择控件的事件
            const pageSizeSelect = document.querySelector('.form-select.form-select-sm');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    pageSize = parseInt(this.value) || 9; // 如果没有选中值，默认为9
                    currentPage = 1; // 重置到第一页
                    loadItemList();
                });
            }
            
            loadItemList();
        });
        
        // 加载拍品列表
        async function loadItemList() {
            try {
                // 获取搜索条件
                const keyword = document.querySelector('input[placeholder="关键词搜索"]').value;
                const status = document.querySelector('select').value;
                const minPrice = document.querySelector('input[placeholder="最低价格"]').value;
                const maxPrice = document.querySelector('input[placeholder="最高价格"]').value;
                
                // 构造请求参数
                const params = {
                    page: currentPage,
                    pageSize: pageSize
                };
                
                if (keyword) params.title = keyword;
                if (status !== '') params.status = status;
                if (minPrice) params.minPrice = minPrice;
                if (maxPrice) params.maxPrice = maxPrice;
                
                // 调用后端接口
                const response = await get('/item/list', params);
                
                if (response.code === 1) {
                    renderItemList(response.data.records);
                    updatePaginationInfo(response.data.total);
                } else {
                    console.error('获取拍品列表失败:', response.msg);
                    showErrorMessage('获取拍品列表失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取拍品列表异常:', error);
                showErrorMessage('获取拍品列表异常');
            }
        }
        
        // 渲染拍品列表
        function renderItemList(items) {
            const container = document.querySelector('.row.g-4');
            container.innerHTML = '';
            
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无拍品数据</div></div>';
                return;
            }
            
            items.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                
                // 根据状态设置标签和按钮文本
                let statusBadge = '';
                let buttonText = '查看详情';
                let buttonClass = 'btn-outline-primary';
                
                switch (item.status) {
                    case 0: // 未开始
                        statusBadge = '<span class="badge bg-secondary">未开始</span>';
                        buttonText = '查看详情';
                        buttonClass = 'btn-outline-primary';
                        break;
                    case 1: // 竞拍中
                        statusBadge = '<span class="badge bg-primary">竞拍中</span>';
                        buttonText = '查看详情并出价';
                        buttonClass = 'btn-primary';
                        break;
                    case 2: // 已结束
                        statusBadge = '<span class="badge bg-success">已结束</span>';
                        buttonText = '查看详情';
                        buttonClass = 'btn-outline-primary';
                        break;
                }
                
                // 设置时间显示
                const timeField = item.status === 2 ? '结束时间' : (item.status === 0 ? '开始时间' : '结束时间');
                const timeValue = item.status === 2 ? item.endTime : (item.status === 0 ? item.startTime : item.endTime);
                
                // 处理图片显示
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `
                        <div class="card-img-container">
                            <img src="${item.image}" alt="拍品图片">
                        </div>`;
                } else {
                    // 如果没有图片，显示默认占位图
                    imageHtml = `
                        <div class="card-img-container">
                            <span class="text-muted">暂无图片</span>
                        </div>`;
                }
                
                col.innerHTML = `
                    <div class="card h-100">
                        ${imageHtml}
                        <div class="card-body">
                            <h5 class="card-title">${item.title}</h5>
                            <p class="card-text text-muted">起拍价：${formatCurrency(item.initialPrice)}</p>
                            <p class="card-text"><strong>${item.status === 2 ? '最终成交价' : '当前最高价'}：${formatCurrency(item.currentMaxPrice)}</strong></p>
                            <p class="card-text small">
                                ${statusBadge}
                                ${timeField}：${formatDateTime(timeValue)}
                            </p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="item-detail.html?id=${item.id}" class="btn ${buttonClass} w-100">${buttonText}</a>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }
        
        // 更新分页信息
        function updatePaginationInfo(total) {
            totalItems = total;
            totalPages = Math.ceil(totalItems / pageSize);
            
            // 更新总条数显示
            document.getElementById('totalItems').textContent = totalItems;
            
            // 更新分页按钮
            updatePagination();
        }
        
        // 格式化货币
        function formatCurrency(amount) {
            return '¥' + parseFloat(amount).toFixed(2);
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadItemList(); // 重新加载数据
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadItemList(); // 重新加载数据
            }
        }

        function goToPage(page) {
            const pageNum = parseInt(page);
            if (pageNum >= 1 && pageNum <= totalPages) {
                currentPage = pageNum;
                loadItemList(); // 重新加载数据
            }
        }

        function updatePagination() {
            // 更新页码按钮状态
            const pageButtonsContainer = document.querySelector('.d-flex.gap-1');
            pageButtonsContainer.innerHTML = '';
            
            // 最多显示5个页码按钮
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('a');
                btn.href = '#';
                btn.className = 'btn btn-sm ' + (i === currentPage ? 'btn-primary' : 'btn-light border') + ' pagination-btn';
                btn.style.cssText = 'width: 32px; height: 32px; padding: 0; line-height: 32px; text-align: center;';
                btn.textContent = i;
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    goToPage(i);
                });
                pageButtonsContainer.appendChild(btn);
            }

            // 更新上一页按钮状态
            const prevBtn = document.querySelector('.prev-btn');
            if (currentPage === 1) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }

            // 更新下一页按钮状态
            const nextBtn = document.querySelector('.next-btn');
            if (currentPage === totalPages || totalPages === 0) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }

            // 更新输入框
            const input = document.querySelector('.goto-input');
            input.value = currentPage;
            input.max = totalPages;
        }

        // 搜索按钮事件
        document.querySelector('.btn-primary').addEventListener('click', function() {
            currentPage = 1; // 重置到第一页
            loadItemList();
        });

        // 重置按钮事件
        document.querySelector('.btn-outline-secondary').addEventListener('click', function() {
            // 清空搜索条件
            document.querySelector('input[placeholder="关键词搜索"]').value = '';
            document.querySelector('select').value = '';
            document.querySelector('input[placeholder="最低价格"]').value = '';
            document.querySelector('input[placeholder="最高价格"]').value = '';
            currentPage = 1; // 重置到第一页
            loadItemList();
        });

        // 页码按钮点击事件
        document.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                goToPage(btn.textContent);
            });
        });

        // 前往按钮
        document.querySelector('.goto-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                goToPage(e.target.value);
            }
        });
        
        // 显示错误信息
        function showErrorMessage(message) {
            const container = document.querySelector('.row.g-4');
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`;
        }
    </script>
</body>
</html>