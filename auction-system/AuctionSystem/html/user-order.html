<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍卖系统 - 我的订单</title>
    <!-- 引入Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="common.css">
    <script src="utils/request.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="index.html">拍卖系统</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">拍品列表</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userNavbar">
                    <!-- 动态加载用户相关的导航项 -->
                </ul>
            </div>
        </div>
    </nav>
    <script>
        // 检查用户登录状态并更新导航栏
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userNavbar = document.getElementById('userNavbar');
            
            if (token) {
                // 用户已登录
                userNavbar.innerHTML = `
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">
                            我的账户
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="user-order.html">我的订单</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
                        </ul>
                    </li>
                `;
            } else {
                // 用户未登录
                userNavbar.innerHTML = `
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">登录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="register.html">注册</a>
                    </li>
                `;
            }
        }
        
        // 页面加载时检查用户登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
    <script>
        // 退出登录函数
        function logout() {
            localStorage.removeItem('token');
            alert('已退出登录');
            window.location.href = 'login.html';
        }
    </script>

    <!-- 订单列表 -->
    <div class="container mt-4">
        <h3 class="mb-4">我的订单</h3>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>订单ID</th>
                                <th>拍品名称</th>
                                <th>成交价格</th>
                                <th>订单状态</th>
                                <th>更新时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载订单数据...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { get, post, formatDateTime } from './utils/request.js';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户登录状态
            const token = localStorage.getItem('token');
            
            if (!token) {
                // 未登录，跳转到登录页面
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }
            
            loadOrders();
        });

        // 加载订单列表
        async function loadOrders() {
            try {
                console.log('开始请求订单数据...');
                const response = await get('/order/my');
                console.log('订单数据响应:', response);
                
                if (response.code === 1) {
                    renderOrders(response.data);
                } else {
                    console.error('获取订单列表失败:', response.msg);
                    showErrorMessage('获取订单列表失败: ' + response.msg);
                }
            } catch (error) {
                console.error('获取订单列表异常:', error);
                showErrorMessage('获取订单列表异常: ' + error.message);
            }
        }

        // 渲染订单列表
        function renderOrders(orders) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center text-muted">暂无订单数据</td>';
                tbody.appendChild(tr);
                return;
            }
            
            orders.forEach(order => {
                const tr = document.createElement('tr');
                
                // 状态文本和样式
                let statusText = '';
                let statusClass = '';
                
                switch (order.status) {
                    case 0: // 待付款
                        statusText = '待付款';
                        statusClass = 'status-pending';
                        break;
                    case 1: // 已完成
                        statusText = '已完成';
                        statusClass = 'status-completed';
                        break;
                    default:
                        statusText = '未知';
                        statusClass = 'status-unknown';
                }
                
                tr.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.itemTitle || '未知拍品'}</td>
                    <td>¥${order.dealPrice.toFixed(2)}</td>
                    <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                    <td>${formatDateTime(order.updateTime)}</td>
                    <td>
                        ${order.status === 0 ? 
                            `<button class="btn btn-sm btn-primary pay-btn" data-id="${order.id}">立即付款</button>` : 
                            ``}
                        <button class="btn btn-sm btn-outline-secondary ms-1 detail-btn" data-item-id="${order.itemId}">查看详情</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // 绑定付款按钮事件
            document.querySelectorAll('.pay-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    payOrder(this.dataset.id);
                });
            });
            
            // 绑定查看详情按钮事件
            document.querySelectorAll('.detail-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewItemDetail(this.dataset.itemId);
                });
            });
        }

        // 付款功能
        async function payOrder(orderId) {
            try {
                const response = await post(`/order/pay/${orderId}`, {
                    address: '默认地址' // 实际应用中应让用户输入地址
                });
                
                if (response.code === 1) {
                    alert('付款成功！');
                    // 重新加载订单列表
                    loadOrders();
                } else {
                    alert('付款失败: ' + response.msg);
                }
            } catch (error) {
                console.error('付款异常:', error);
                alert('付款异常，请稍后重试');
            }
        }



        // 显示错误信息
        function showErrorMessage(message) {
            const container = document.querySelector('.card-body');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }
        
        // 查看拍品详情
        function viewItemDetail(itemId) {
            if (itemId) {
                window.location.href = `item-detail.html?id=${itemId}`;
            } else {
                alert('无法获取拍品信息');
            }
        }
    </script>
</body>
</html>